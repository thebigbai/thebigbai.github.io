<!DOCTYPE html>
<html>
<head>
	<meta name="baidu-site-verification" content="MmSp9r4WgS" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
	
    <link rel="shortcut icon" href="/images/favicon/favicon.png" type="image/x-icon">
    <link rel="icon" href="/images/favicon/favicon.png" type="image/x-icon">

    <title>The BIGBAI</title>
	
    <!--Library Styles-->    
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/lib/font-awesome.css" rel="stylesheet">
    <link href="/css/lib/nivo-lightbox.css" rel="stylesheet">
    <link href="/css/lib/nivo-themes/default/default.css" rel="stylesheet">
	
    <!--Template Styles-->
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/scheme/purple.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
      <script src="/js/respond.min.js"></script>
    <![endif]-->
</head>
<body data-spy="scroll" id="top">
	<div id="main-wrapper">
		<!-- Site Navigation -->
		<div id="menu">
	<nav class="navbar navbar-default" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-navbar-collapse">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="index.html#">
				<img src="/images/logo.png" alt="logo">
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-navbar-collapse">
			<ul class="nav navbar-nav">
				
					<li><a class="nav-font-size" href="/">Home</a></li>
				
					<li><a class="nav-font-size" href="/archives">Archives</a></li>
				
					<li><a class="nav-font-size" href="/about">About</a></li>
				
			</ul>
		</div>
		<!-- /.navbar-collapse -->
	</nav>
</div>

	  
		<div id="container" style="max-width:100%;">
			<section id="blog-full" class="blog">
	<div class="row">
		<div class="col-md-9">
			<div id="primary" class="row">
				<div class="blog-post">
					<!-- Title -->
					<h2 class="post-title">
						<a class="article-full-color">
							Windows事件监控
						</a>
					</h2>
					
					<!-- Tags and Categories links -->
					
					

<div class="blog-tags-container">
    <span class="glyphicon glyphicon-tags"></span>
    <a href="/tags/C/">#C++</a>
</div>

				
					

<div class="blog-categories-container">
    <span class="glyphicon glyphicon-folder-open"></span>
    <a href="/categories/Interesting-Trick/">Interesting Trick</a>
</div>


					<!-- Date and Author -->
					<p class="post-meta">
						2016-11-03
						
					</p>

					<!-- Content -->
					<div id="2016-11-03" class="post-content">
					
						<!-- Table of Contents -->
						
						<div id="toc" class="toc-article">
							<strong class="toc-title">Table of Content</strong>
							<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows鼠标键盘Hook"><span class="toc-text">Windows鼠标键盘Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pyHook"><span class="toc-text">pyHook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-Hook"><span class="toc-text">C++ Hook</span></a></li></ol></li></ol>
						</div>
						
						
						
						<!-- toc -->
<p>最近的工作中，有个需求，需要监控用户使用Windows电脑时候的鼠标键盘事件、cpu内存使用量、以及守护另外一个程序。涉及到的一些知识，个人觉得除非以后要写个外挂、流氓软件、或者是盗号软件，应该以后都不会用到了。<br>但是个人觉得还是记录下来一些比较好，万一以后要用到还忘记了，就TM尴尬了。<br>难说以后混不下去了，还可以去盗号赚点生活费什么的。<br><a id="more"></a></p>
<h2 id="Windows鼠标键盘Hook"><a href="#Windows鼠标键盘Hook" class="headerlink" title="Windows鼠标键盘Hook"></a><a style="color:#AE8D73"><strong>Windows鼠标键盘Hook</strong></a></h2><p>这部分本来使用PyHook做的，因为用python写起来比较简单。后来由于项目需要，改成用C++了。但是还是决定把pyHook的方法记录一下，免得以后找起来麻烦。</p>
<h3 id="pyHook"><a href="#pyHook" class="headerlink" title="pyHook"></a><a style="color:#AE8D73"><strong>pyHook</strong></a></h3><p>首先，肯定是要安装好<a href="http://sourceforge.net/projects/pyhook/files/pyhook/1.5.1/" target="_blank" rel="external">pyHook</a>和<a href="https://sourceforge.net/projects/pywin32/" target="_blank" rel="external">pywin32</a>。毕竟需要调用的其实还是windows API。<br>之后代码就非常简单了，在<em>import pythoncom 和 import pyHook </em>之后：<br><figure class="highlight python"><figcaption><span>main</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">	hm = pyHook.HookManager() </div><div class="line">  </div><div class="line">	hm.KeyDown = onKeyboardEvent      </div><div class="line">	hm.HookKeyboard()   </div><div class="line">	hm.MouseAll = onMouseEvent   </div><div class="line">	hm.HookMouse()    </div><div class="line">	</div><div class="line">	pythoncom.PumpMessages()</div></pre></td></tr></table></figure><br>以上创建了pyHook的句柄hm之后，剩下的其实就是两句话： 1.设置好回调函数<em>onKeyboardEvent()</em>和<em>onMouseEvent()</em>；2.挂上钩子<em>HookKeyboard()</em>和<em>HookMouse()</em>。<br>然后在回调函数里就可以查看的需要的各种监听信息了。针对不同的程序功能，可以自己筛选需要的信息处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">onMouseEvent</span><span class="params">(event)</span>:</span> </div><div class="line">     </div><div class="line">   <span class="keyword">print</span> <span class="string">"MessageName:"</span>,event.MessageName     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Message:"</span>, event.Message     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Time:"</span>, event.Time     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Window:"</span>, event.Window     </div><div class="line">   <span class="keyword">print</span> <span class="string">"WindowName:"</span>, event.WindowName     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Position:"</span>, event.Position     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Wheel:"</span>, event.Wheel     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Injected:"</span>, event.Injected           </div><div class="line">  </div><div class="line">   <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line">   </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">onKeyboardEvent</span><span class="params">(event)</span>:</span>  </div><div class="line">   </div><div class="line">   <span class="keyword">print</span> <span class="string">"MessageName:"</span>, event.MessageName     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Message:"</span>, event.Message     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Time:"</span>, event.Time     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Window:"</span>, event.Window     </div><div class="line">   <span class="keyword">print</span> <span class="string">"WindowName:"</span>, event.WindowName     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Ascii:"</span>, event.Ascii, chr(event.Ascii)     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Key:"</span>, event.Key     </div><div class="line">   <span class="keyword">print</span> <span class="string">"KeyID:"</span>, event.KeyID     </div><div class="line">   <span class="keyword">print</span> <span class="string">"ScanCode:"</span>, event.ScanCode     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Extended:"</span>, event.Extended     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Injected:"</span>, event.Injected     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Alt"</span>, event.Alt     </div><div class="line">   <span class="keyword">print</span> <span class="string">"Transition"</span>, event.Transition  </div><div class="line">   </div><div class="line">   <span class="keyword">return</span> <span class="keyword">True</span></div></pre></td></tr></table></figure>
<p>这里有一个很神奇的地方，鼠标事件中<em>event.WindowName</em>是可以获取到鼠标点击处所对应的窗口名字的，但是有的时候在某一个程序的窗口中点击可能会获取不到，这个应该是因为，该程序有子窗体，子窗体没有设置<br>名字，而我的钩子又没办法钩到父级窗口（至少目前我是不知道怎么钩到父级的。如果有人知道，麻烦告诉我一下），所以获取不到程序的名字。而神奇之处在于键盘事件的<em>event.WindowName</em>是无论如果都能获取主程序窗口名字的。<br>我也是搞不懂为什么。</p>
<p>最后的<em>return True</em>也是非常关键，相当于把消息又从钩子交回去了，这样我们的系统才能。如果是<em>false</em>，则事件会被<br>钩子全部拦截，鼠标键盘就失去响应了。</p>
<h3 id="C-Hook"><a href="#C-Hook" class="headerlink" title="C++ Hook"></a><a style="color:#AE8D73"><strong>C++ Hook</strong></a></h3><p>C++的方式自然就SB多了，</p>

					</div>
					
					
					<p></p>
					<div class="denote">
						<div>
							<img onclick="load_pic()" id="aliqcode" class="denote_img img-responsive center-block" src="" />
						</div>
						<a class="donate_btn" id="donate_btn" onclick="load_pic()" >￥ Donate me.</a>
					</div>
					<p></p>
					<!--share-->
					<div class="ds-share flat" data-thread-key="post-2016/11/03/Windows-事件监测/-Windows-事件监测" data-title="Windows事件监控" data-images="" data-content="" data-url="http://www.bigbai.com.cn/2016/11/03/Windows-事件监测/">
						<div class="ds-share-inline">
							<div class="ds-share-icons-more">
							</div>
							<ul  class="ds-share-icons-16">		
								<li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">Share: </a></li>
								<li> <a class="ds-wechat" href="javascript:void(0);" data-service="wechat">&nbsp</a> </li>
								<li> <a class="ds-weibo" href="javascript:void(0);" data-service="weibo">&nbsp</a> </li>
								<li> <a class="ds-facebook" href="javascript:void(0);" data-service="facebook">&nbsp</a> </li> 
								<li> <a class="ds-twitter" href="javascript:void(0);" data-service="twitter">&nbsp</a> </li>
								
							</ul>
							
						</div>
					 </div>
					 <!--END SHARE-->


					<!-- 多说评论框 start -->
						<div class="ds-thread" data-thread-key="post-2016/11/03/Windows-事件监测/-Windows-事件监测" data-title="Windows事件监控" data-url="http://www.bigbai.com.cn/2016/11/03/Windows-事件监测/"></div>
						<!-- 多说评论框 end -->
						<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
						<script type="text/javascript">
							var duoshuoQuery = {short_name:"bigbai"};
								(function() {
									var ds = document.createElement('script');
									ds.type = 'text/javascript';ds.async = true;
									ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
									ds.charset = 'UTF-8';
									(document.getElementsByTagName('head')[0] 
									 || document.getElementsByTagName('body')[0]).appendChild(ds);
								})();
						</script>
					<!-- 多说公共JS代码 end -->
				</div>
			</div>	
		</div>
		<!-- SIDE BAR -->
<div class="col-md-3 sidebar">
	<div class="row widget">
		<div class="col-md-12">
			<div class="categories-widget">
				<h3 class="widget-title">
					Categories
				</h3>
				<ul>
					<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Interesting-Trick/">Interesting Trick</a><span class="category-list-count">2</span></li></ul>
				</ul>
			</div>
		</div>
	</div>
	
	<div class="row widget">
		<div class="col-md-12">
			<div class="categories-widget">
				<h3 class="widget-title">
					Tags
				</h3
				<ul>
					<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li></ul>
				</ul>
			</div>
		</div>
	</div>
	
	<div class="row widget">
		<div class="col-md-12">
			<div class="categories-widget">
				<h3 class="widget-title">
					Archives
				</h3
				<ul>
					<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">2</span></li></ul>
				</ul>
			</div>
		</div>
	</div>
</div>


			
	</div>
</section>

		</div>
		
	</div>
	<div>
		<!-- BEGIN FOOTER -->
<footer>
	<div class="row">
		<div class="col-md-12">
			<p style="margin-bottom: 0">
				© 2016 Designed by BIGBAI. Adapted to <a href="https://hexo.io/"> Hexo</a>
			</p>             
			<p >
				-Friend：<a href="http://blackpoint-cx.github.io">BlackPoint</a>- 
			</p>
		</div>
	</div>
</footer>
<!-- END FOOTER -->



<!-- Back to top -->
<div id="backtotop">       
	<a class="to-top-btn sscroll" href="#top"><i class="fa fa-angle-double-up"></i></a>
</div>
	</div>

    <!-- Library Scripts -->
	<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/lib/jquery.preloader.js"></script>
<script src="/js/lib/nivo-lightbox.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/lib/jquery.superslides.min.js"></script>
<script src="/js/lib/smoothscroll.js"></script>
<!--<script src="/js/lib/jquery.sudoslider.min.js"></script>-->
<script src="/js/lib/jquery.bxslider.min.js"></script>
<script src="/js/lib/jquery.mixitup.min.js"></script>
<script src="/js/lib/jquery.backtotop.js"></script>
<script src="/js/lib/jquery.carouFredSel-6.2.1-packed.js"></script>
<script src="/js/lib/retina.min.js"></script>

<!-- Custom Script -->    
<script src="/js/main.js"></script>

<script>
	function load_pic(){
		var imgObj = document.getElementById("aliqcode");
		var Flag=(imgObj.getAttribute("src",2)=="/images/wechat.jpg")
		imgObj.src=Flag?"":"/images/wechat.jpg";
		
		var textObj = document.getElementById("donate_btn");
		if(textObj.innerHTML =="Scan WeChat QR Code")
		{
			textObj.innerHTML ="￥ Donate me.";
		}
		else
		{
			textObj.innerHTML ="Scan WeChat QR Code";
		}
	}
</script>
</body>

</html>
